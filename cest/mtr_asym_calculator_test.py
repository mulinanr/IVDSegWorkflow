import numpy as np
import unittest

from cest import mtr_asym_calculator
from cest import cest_corrector_test
from utils import common_functions

sSlide = 1
fshift = 1.5
dfreq = 0.6
lmo = 'B'
gauss = 3.0
S0yn = 1
zFilter = False

def createMtrAsymCalculator():
    return mtr_asym_calculator.MtrAsymCalculator(sSlide, fshift, dfreq, lmo, gauss, S0yn, zFilter)

def createCestCurves(Mask):
    sName = '../DICOM_TEST/A_WASSR_99677'
    cestFilesPath = '../DICOM_TEST/gagCEST_12_99476/'
    filename = 'gagCEST_12_99476_sl_1_dyn_'
    Offsets = cest_corrector_test.prepareOfsetts(sName, Mask, 0.01, 1.0)
    cestCorrector = cest_corrector_test.createCestCorrector()

    (CestCurveS, x_calcentries) = cestCorrector.calculateCestAmlEvaluation(cestFilesPath, Offsets, sName, filename, Mask)

    return (CestCurveS, x_calcentries)



class MtrAsymCalculatorTest(unittest.TestCase):

    def test_constructor(self):
        calculator = createMtrAsymCalculator()

        self.assertEqual(sSlide, calculator.sSlide)
        self.assertEqual(fshift, calculator.fshift)
        self.assertEqual(dfreq, calculator.dfreq)
        self.assertEqual(lmo, calculator.lmo)
        self.assertEqual(gauss, calculator.gauss)
        self.assertEqual(S0yn, calculator.S0yn)
        self.assertEqual(zFilter, calculator.zFilter)


    def test_calculateMtrAsymCurves(self):
        Mask = common_functions.createTestMask(192, 192, 5) 
        (CestCurveS, x_calcentries) = createCestCurves(Mask)
        calculator = createMtrAsymCalculator()

        (MTRasymCurves, MTRasym_Bild) = calculator.calculateMtrAsymCurves(CestCurveS, x_calcentries, Mask)

        self.assertEqual((192, 192, 2, 301), MTRasymCurves.shape)
        self.assertEqual((192, 192), MTRasym_Bild.shape)



    def test_(self):
        curves = np.array([0.711060666701510, 0.721758303154545, 0.735270640383694, 0.751325479135429, 0.769650620156222, 0.789973864192546, 0.812023011990874, 0.835525864297679, 0.860210221859435, 0.885803885422613, 0.912034655733686, 0.938630333539127, 0.965318719585410, 0.991827614619008, 1.01788481938639, 1.04321813463403, 1.06755536110841, 1.09062429955599, 1.11215275072325, 1.13186851535666, 1.14949939420269, 1.16477318800782, 1.17741769751852, 1.18716072348126, 1.19373006664251, 1.19857079511273, 1.20330527081684, 1.20792723522300, 1.21243042979938, 1.21680859601415, 1.22105547533549, 1.22516480923156, 1.22913033917054, 1.23294580662059, 1.23660495304988, 1.24010151992659, 1.24342924871889, 1.24658188089495, 1.24955315792293, 1.25233682127100, 1.25492661240735, 1.25731627280013, 1.25949954391752, 1.26147016722768, 1.26322188419880, 1.26474843629903, 1.26604356499656, 1.26710101175954, 1.26791451805615, 1.26847782535456, 1.26878467512294, 1.26857849089644, 1.26470770024752, 1.25650483301743, 1.24433089558793, 1.22854689434078, 1.20951383565776, 1.18759272592062, 1.16314457151113, 1.13653037881105, 1.10811115420215, 1.07824790406620, 1.04730163478494, 1.01563335274016, 0.983604064313620, 0.951574775887076, 0.919906493842297, 0.888960224561046, 0.859096974425089, 0.830677749816190, 0.804063557116112, 0.779615402706622, 0.757694292969481, 0.738661234286457, 0.722877233039312, 0.710703295609812, 0.702500428379720, 0.698629637730802, 0.698461222879179, 0.698960639357070, 0.699868621325067, 0.701166549632723, 0.702835805129593, 0.704857768665229, 0.707213821089186, 0.709885343251018, 0.712853716000277, 0.716100320186518, 0.719606536659294, 0.723353746268160, 0.727323329862668, 0.731496668292372, 0.735855142406827, 0.740380133055586, 0.745053021088202, 0.749855187354229, 0.754768012703221, 0.759772877984733, 0.764851164048316, 0.769984251743525, 0.775153521919914, 0.780340355427037, 0.785526133114446, 0.790692235831697, 0.795820044428342, 0.801473880957949, 0.808164115891217, 0.815791202703398, 0.824255594869744, 0.833457745865508, 0.843298109165940, 0.853677138246293, 0.864495286581818, 0.875653007647768, 0.887050754919394, 0.898588981871948, 0.910168141980682, 0.921688688720848, 0.933051075567698, 0.944155755996484, 0.954903183482457, 0.965193811500869, 0.974928093526973, 0.984006483036020, 0.992329433503262, 0.999797398403951, 1.00631083121334, 1.01177018540668, 1.01607591445922, 1.01912847184621, 1.02082831104291, 1.02083623793900, 1.01609772599895, 1.00605600898612, 0.991153020656548, 0.971830694766318, 0.948530965071491, 0.921695765328136, 0.891767029292315, 0.859186690720098, 0.824396683367549, 0.787838940990736, 0.749955397345722, 0.711187986188578, 0.671978641275366, 0.632769296362156, 0.594001885205012, 0.556118341559998, 0.519560599183186, 0.484770591830636, 0.452190253258419, 0.422261517222599, 0.395426317479243, 0.372126587784417, 0.352804261894187, 0.337901273564620, 0.327859556551781, 0.323121044611738, 0.324540688896305, 0.333420968453293, 0.349285737549483, 0.371536325652947, 0.399574062231749, 0.432800276753961, 0.470616298687648, 0.512423457500882, 0.557623082661727, 0.605616503638255, 0.655805049898531, 0.707590050910627, 0.760372836142607, 0.813554735062543, 0.866537077138500, 0.918721191838549, 0.969508408630758, 1.01830005698319, 1.06449746636393, 1.10750196624102, 1.14671488608255, 1.18153755535658, 1.21137130353118, 1.23561746007441, 1.25367735445435, 1.26495231613907, 1.26884367459662, 1.26646153348127, 1.25954976384114, 1.24846034623514, 1.23354526122215, 1.21515648936107, 1.19364601121081, 1.16936580733025, 1.14266785827830, 1.11390414461386, 1.08342664689581, 1.05158734568305, 1.01873822153449, 0.985231255009016, 0.951418426665527, 0.917651717062919, 0.884283106760091, 0.851664576315937, 0.820148106289357, 0.790085677239243, 0.761829269724497, 0.735730864304011, 0.712142441536686, 0.691415981981415, 0.673903466197097, 0.659956874742628, 0.649928188176905, 0.643936771166393, 0.639199868343119, 0.634792967554782, 0.630694337887486, 0.626882248427337, 0.623334968260440, 0.620030766472897, 0.616947912150815, 0.614064674380298, 0.611359322247450, 0.608810124838376, 0.606395351239181, 0.604093270535969, 0.601882151814845, 0.599740264161913, 0.597645876663279, 0.595577258405046, 0.593512678473319, 0.591430405954204, 0.589308709933803, 0.587125859498223, 0.584860123733567, 0.582489771725941, 0.579993072561449, 0.577348295326195, 0.574533709106285, 0.571527582987822, 0.568283300964332, 0.564724440132565, 0.560878559575920, 0.556780487033404, 0.552465050244022, 0.547967076946781, 0.543321394880684, 0.538562831784740, 0.533726215397953, 0.528846373459329, 0.523958133707874, 0.519096323882593, 0.514295771722493, 0.509591304966579, 0.505017751353858, 0.500609938623334, 0.496402694514014, 0.492430846764903, 0.488729223115007, 0.485332651303332, 0.482275959068885, 0.479593974150669, 0.477321524287692, 0.475493437218959, 0.474144540683476, 0.473309662420248, 0.473023630168282, 0.476280428424005, 0.485716792600841, 0.500831676813295, 0.521124035175872, 0.546092821803076, 0.575236990809411, 0.608055496309381, 0.644047292417491, 0.682711333248244, 0.723546572916147, 0.766051965535700, 0.809726465221412, 0.854069026087783, 0.898578602249321, 0.942754147820527, 0.986094616915909, 1.02809896364997, 1.06826614213721, 1.10609510649213, 1.14108481082925, 1.17273420926307, 1.20054225590808, 1.22400790487880, 1.24263011028972, 1.25590782625536, 1.26334000689021, 1.26453466058480, 1.26066386993589, 1.25246100270579, 1.24028706527629, 1.22450306402915, 1.20547000534612, 1.18354889560898, 1.15910074119949, 1.13248654849941, 1.10406732389052, 1.07420407375456, 1.04325780447331, 1.01158952242853, 0.979560234001985, 0.947530945575440, 0.915862663530662, 0.884916394249412, 0.855053144113454, 0.826633919504554, 0.800019726804476, 0.775571572394986, 0.753650462657846, 0.734617403974822, 0.718833402727677, 0.706659465298176, 0.698456598068085, 0.694585807419166, 0.695054270322439, 0.698789339788769, 0.705462104340978, 0.714820761543132, 0.726613508959300, 0.740588544153549, 0.756494064689946, 0.774078268132558, 0.793089352045455, 0.813275513992703, 0.834384951538370, 0.856165862246523, 0.878366443681230, 0.900734893406558, 0.923019408986576, 0.944968187985351, 0.966329427966949, 0.986851326495441, 1.00628208113489, 1.02436988944937, 1.04086294900294, 1.05550945735968, 1.06805761208364, 1.07825561073890, 1.08585165088953, 1.09059393009959, 1.09223064593315, 1.09142892142777, 1.08910597606603, 1.08538515207951, 1.08038979169983, 1.07424323715857, 1.06706883068734, 1.05898991451773, 1.05012983088134, 1.04061192200976, 1.03055953013459, 1.02009599748744, 1.00934466629989, 0.998428878803542, 0.987471977229998, 0.976597303810852, 0.965928200777701, 0.955588010362142, 0.945700074795773, 0.936387736310191, 0.927774337136992, 0.919983219507774, 0.913137725654133, 0.907361197807668, 0.902776978199975, 0.899508409062651, 0.897678832627294, 0.897745084264480, 0.903957692862907, 0.917123272742476, 0.936662409629759, 0.961995689251325, 0.992543697333749, 1.02772701960360, 1.06696624178745, 1.10968194961187, 1.15529472880343, 1.20322516508871, 1.25289384419427, 1.30372135184669, 1.35512827377254, 1.40653519569839, 1.45736270335081, 1.50703138245637, 1.55496181874165, 1.60057459793321, 1.64329030575763, 1.68252952794148, 1.71771285021133, 1.74826085829376, 1.77359413791533, 1.79313327480261, 1.80629885468218, 1.81251146328060, 1.81056391466435, 1.79848187634549, 1.77689711125898, 1.74662413884206, 1.70847747853194, 1.66327164976586, 1.61182117198104, 1.55494056461471, 1.49344434710409, 1.42814703888642, 1.35986315939892, 1.28940722807881, 1.21759376436332, 1.14523728768968, 1.07315231749512, 1.00215337321686, 0.933054974292128, 0.866671640158154, 0.803817890252159, 0.745308244011376, 0.691957220873027, 0.644579340274341, 0.603989121652544, 0.571001084444863, 0.546429748088524, 0.531089632020755, 0.525795255678781, 0.526007678410976, 0.526633199728361, 0.527654199312137, 0.529053056843505, 0.530812152003663, 0.532913864473814, 0.535340573935158, 0.538074660068894, 0.541098502556223, 0.544394481078346, 0.547944975316463, 0.551732364951775, 0.555739029665481, 0.559947349138783, 0.564339703052881, 0.568898471088974, 0.573606032928264, 0.578444768251951, 0.583397056741236, 0.588445278077318, 0.593571811941398, 0.598759038014677, 0.603989335978355, 0.609245085513632, 0.614508666301710, 0.619762458023787, 0.625061143490213, 0.631299633676317, 0.638663866452396, 0.647043714825950, 0.656329051804483, 0.666409750395498, 0.677175683606497, 0.688516724444982, 0.700322745918456, 0.712483621034422, 0.724889222800382, 0.737429424223840, 0.749994098312296, 0.762473118073255, 0.774756356514218, 0.786733686642689, 0.798294981466169, 0.809330113992161, 0.819728957228168, 0.829381384181693, 0.838177267860238, 0.846006481271305, 0.852758897422397, 0.858324389321017, 0.862592829974668, 0.865454092390851, 0.866798049577070, 0.866073789407099, 0.861919284129737, 0.854497190431978, 0.844087587321285, 0.830970553805120, 0.815426168890945, 0.797734511586224, 0.778175660898419, 0.757029695834993, 0.734576695403407, 0.711096738611125, 0.686869904465610, 0.662176271974325, 0.637295920144729, 0.612508927984288, 0.588095374500465, 0.564335338700722, 0.541508899592519, 0.519896136183321, 0.499777127480591, 0.481431952491791, 0.465140690224383, 0.451183419685830, 0.439840219883594, 0.431391169825139, 0.426116348517927, 0.424295834969420, 0.426951339846106, 0.434645495001633, 0.446969761224202, 0.463515599302017, 0.483874470023279, 0.507637834176189, 0.534397152548950, 0.563743885929765, 0.595269495106837, 0.628565440868364, 0.663223184002550, 0.698834185297600, 0.734989905541714, 0.771281805523092, 0.807301346029939, 0.842639987850457, 0.876889191772847, 0.909640418585310, 0.940485129076050, 0.969014784033269, 0.994820844245169, 1.01749477049995, 1.03662802358582, 1.05181206429097, 1.06263835340362, 1.06869835171195, 1.06986198232200, 1.06946621905596, 1.06860856854336, 1.06730406386803, 1.06556773811383, 1.06341462436461, 1.06085975570423, 1.05791816521652, 1.05460488598534, 1.05093495109455, 1.04692339362799, 1.04258524666951, 1.03793554330297, 1.03298931661221, 1.02776159968108, 1.02226742559344, 1.01652182743314, 1.01053983828402, 1.00433649122993, 0.997926819354738, 0.991325855742279, 0.984548633476409, 0.977610185640978, 0.970525545319835, 0.963309745596832, 0.955977819555819, 0.948544800280647, 0.940328096083868, 0.929192034744434, 0.915224382581233, 0.898691975114046, 0.879861647862655, 0.859000236346845, 0.836374576086399, 0.812251502601100, 0.786897851410727, 0.760580458035068, 0.733566157993904, 0.706121786807017, 0.678514179994190, 0.651010173075208, 0.623876601569851, 0.597380300997905, 0.571788106879150, 0.547366854733371, 0.524383380080349, 0.503104518439869, 0.483797105331713, 0.466727976275663, 0.452163966791503, 0.440371912399016, 0.431618648617985, 0.426171010968192, 0.424295834969420, 0.425515055138891, 0.429047667424794, 0.434706099493364, 0.442302779010837, 0.451650133643448, 0.462560591057431, 0.474846578919023, 0.488320524894459, 0.502794856649973, 0.518082001851801, 0.533994388166179, 0.550344443259340, 0.566944594797522, 0.583607270446958, 0.600144897873885, 0.616369904744537])
        x_calcentries = np.arange(-3, 3.01, 0.01).transpose()
        mask = 1
        entries = 601
        calculator = createMtrAsymCalculator()

        (MTRasymCurves0, MTRasymCurves1, MTRasym_Bild) = calculator.calculateMtrAsymElement(curves, mask, entries, x_calcentries)
        
        self.assertEqual((301,), MTRasymCurves0.shape)
        self.assertEqual((301,), MTRasymCurves1.shape)

        self.assertTrue(abs( 5.436607231909827 - MTRasym_Bild) < abs(MTRasym_Bild) * 0.1)
